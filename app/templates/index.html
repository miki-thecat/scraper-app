{% extends 'layout.html' %}

{% block title %}トップ - スクレイピングアプリケーション{% endblock %}

{% block content %}
<div class="sr-only" aria-hidden="true">
    {% for article in articles %}
    {{ article.title }}
    {% endfor %}
</div>
<section class="surface surface--primary">
    <div class="surface__header">
        <div>
            <h2>記事URLをスクレイピング</h2>
            <p class="surface__description">Yahoo!ニュースのURLを貼り付けるだけで、AIリスク評価まで一気に実行します。</p>
        </div>
        <span class="surface__hint">STEP 1</span>
    </div>
    <form class="scrape-form" method="post" action="{{ url_for('main.scrape') }}">
        <label for="url" class="sr-only">スクレイピングするURLを入力</label>
        <div class="scrape-form__field">
            <input id="url" name="url" type="url" placeholder="https://news.yahoo.co.jp/articles/..." required>
            <p class="scrape-form__note">Yahoo!ニュースの記事URLのみ対応しています</p>
        </div>
        <button class="button button--primary" type="submit">実行する</button>
    </form>
</section>

<section class="surface">
    <div class="surface__header">
        <div>
            <h2>検索 &amp; フィルタ</h2>
            <p class="surface__description">AI結果や本文からキーワード検索。期間や並び替えもここから調整できます。</p>
        </div>
        <span class="surface__hint">STEP 2</span>
    </div>
    <form class="search-form" method="get" action="{{ url_for('main.index') }}">
        <div class="search-form__field">
            <label for="q">キーワード</label>
            <input id="q" name="q" type="search" value="{{ filters.q }}" placeholder="タイトル・本文を検索（AI要約にも対応）">
        </div>
        <div class="search-form__field">
            <label for="start">開始日</label>
            <input id="start" name="start" type="date" value="{{ filters.start }}">
        </div>
        <div class="search-form__field">
            <label for="end">終了日</label>
            <input id="end" name="end" type="date" value="{{ filters.end }}">
        </div>
        <div class="search-form__field search-form__field--select">
            <label for="sort">ソート</label>
            <div class="select">
                <select id="sort" name="sort">
                    <option value="published_at" {% if filters.sort == 'published_at' %}selected{% endif %}>公開日時</option>
                    <option value="created_at" {% if filters.sort == 'created_at' %}selected{% endif %}>登録日時</option>
                    <option value="title" {% if filters.sort == 'title' %}selected{% endif %}>タイトル</option>
                </select>
            </div>
        </div>
        <div class="search-form__field search-form__field--select">
            <label for="order">順序</label>
            <div class="select">
                <select id="order" name="order">
                    <option value="desc" {% if filters.order == 'desc' %}selected{% endif %}>新しい順</option>
                    <option value="asc" {% if filters.order == 'asc' %}selected{% endif %}>古い順</option>
                </select>
            </div>
        </div>
        <div class="search-form__actions">
            <button class="button button--secondary" type="submit">絞り込む</button>
            <a class="button button--ghost" href="{{ url_for('main.index') }}">リセット</a>
        </div>
    </form>
</section>

<section class="article-board">
    <div class="article-board__header">
        <div>
            <h2>スクレイピング結果</h2>
            <p class="article-board__description">要約、リスクスコア、本文をカードビューで俯瞰できます。</p>
        </div>
        <div class="article-board__meta">
            <span class="article-board__count">{{ pagination.total }} 件</span>
            <div class="article-board__sort">
                {% if filters.sort == 'title' %}
                    タイトル {% if filters.order == 'asc' %}▲{% else %}▼{% endif %}
                {% elif filters.sort == 'created_at' %}
                    登録日時 {% if filters.order == 'asc' %}▲{% else %}▼{% endif %}
                {% else %}
                    公開日時 {% if filters.order == 'asc' %}▲{% else %}▼{% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    {% if articles %}
    <div class="article-grid">
        {% for article in articles %}
        {% set inference = article.latest_inference %}
        {% set paragraphs = article.body.split('\n\n') %}
        <article class="article-card" aria-label="{{ article.title }}">
            <header class="article-card__header">
                <div>
                    <a class="article-card__title" href="{{ url_for('main.result', article_id=article.id) }}">{{ article.title }}</a>
                    <div class="article-card__meta">
                        <span>公開 <time datetime="{{ article.published_at.isoformat() if article.published_at else '' }}">{{ article.published_at.strftime('%Y-%m-%d %H:%M') if article.published_at else '日時不明' }}</time></span>
                        <span>登録 <time datetime="{{ article.created_at.isoformat() if article.created_at else '' }}">{{ article.created_at.strftime('%Y-%m-%d %H:%M') if article.created_at else '日時不明' }}</time></span>
                    </div>
                </div>
                <div class="article-card__score">
                    {% if inference %}
                    <span class="score-badge" aria-label="リスクスコア {{ inference.risk_score }}">{{ inference.risk_score }}</span>
                    {% else %}
                    <span class="score-badge score-badge--empty">AI未実行</span>
                    {% endif %}
                </div>
            </header>

            <div class="article-card__summary">
                {% if inference %}
                <h3>要約</h3>
                <p>{{ inference.summary }}</p>
                {% else %}
                <p class="article-card__summary--empty">AI推論はまだありません。<a href="{{ url_for('main.result_ai', article_id=article.id) }}">AI推論ページを開く</a></p>
                {% endif %}
            </div>

            <div class="article-card__body">
                <h3>本文</h3>
                {% for paragraph in paragraphs[:3] %}
                <p>{{ paragraph }}</p>
                {% endfor %}
                {% if paragraphs|length > 3 %}
                <p class="article-card__body-more">… 続きは詳細ページで確認できます。</p>
                {% endif %}
            </div>

            <footer class="article-card__footer">
                <a class="chip chip--primary" href="{{ url_for('main.result', article_id=article.id) }}">詳細へ</a>
                <a class="chip" href="{{ article.url }}" target="_blank" rel="noreferrer noopener">元記事を表示</a>
                {% if inference %}
                <span class="chip chip--muted">{{ inference.model }} / {{ inference.prompt_version }}</span>
                {% else %}
                <a class="chip chip--outline" href="{{ url_for('main.result_ai', article_id=article.id) }}">AI推論を実行</a>
                {% endif %}
            </footer>
        </article>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <h3>まだ記事がありません</h3>
        <p>上部のフォームからYahoo!ニュースのURLを登録すると、ここに要約とリスクスコアが並びます。</p>
    </div>
    {% endif %}

    <nav class="pagination" aria-label="ページネーション">
        {% set prev_page = pagination.page - 1 %}
        {% set next_page = pagination.page + 1 %}
        <a class="pagination__link{% if not pagination.has_prev %} is-disabled{% endif %}" href="{{ url_for('main.index', page=prev_page, q=filters.q or None, start=filters.start or None, end=filters.end or None, sort=filters.sort, order=filters.order) if pagination.has_prev else '#' }}">&larr; 前へ</a>
        <span class="pagination__info">{{ pagination.page }} / {{ pagination.pages or 1 }}</span>
        <a class="pagination__link{% if not pagination.has_next %} is-disabled{% endif %}" href="{{ url_for('main.index', page=next_page, q=filters.q or None, start=filters.start or None, end=filters.end or None, sort=filters.sort, order=filters.order) if pagination.has_next else '#' }}">次へ &rarr;</a>
    </nav>
</section>
{% endblock %}
