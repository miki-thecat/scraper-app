{% extends 'layout.html' %}

{% block title %}トップ - スクレイピングアプリケーション{% endblock %}

{% block content %}
<section class="filters">
    <form class="scrape-form" method="post" action="{{ url_for('main.scrape') }}">
        <label for="url" class="sr-only">スクレイピングするURLを入力</label>
        <input id="url" name="url" type="url" placeholder="スクレイピングするURLを入力" required>
        <button type="submit">実行</button>
    </form>

    <form class="search-form" method="get" action="{{ url_for('main.index') }}">
        <div class="search-form__field">
            <label for="q">キーワード</label>
            <input id="q" name="q" type="search" value="{{ filters.q }}" placeholder="タイトル・本文を検索">
        </div>
        <div class="search-form__field">
            <label for="start">開始日</label>
            <input id="start" name="start" type="date" value="{{ filters.start }}">
        </div>
        <div class="search-form__field">
            <label for="end">終了日</label>
            <input id="end" name="end" type="date" value="{{ filters.end }}">
        </div>
        <div class="search-form__actions">
            <button type="submit">絞り込み</button>
            <a class="search-form__reset" href="{{ url_for('main.index') }}">リセット</a>
        </div>
    </form>
</section>

<section class="table-wrap">
    <table>
        <thead>
            <tr>
                <th>タイトル</th>
                <th>リスクスコア</th>
                <th>要約</th>
                <th>本文</th>
            </tr>
        </thead>
        <tbody>
            {% if articles %}
                {% for article in articles %}
                <tr>
                    <td>
                        <div class="cell-title">
                            <a href="{{ url_for('main.result', article_id=article.id) }}">{{ article.title }}</a>
                            <div class="cell-sub">
                                <time datetime="{{ article.published_at.isoformat() if article.published_at else '' }}">
                                    {{ article.published_at.strftime('%Y-%m-%d %H:%M') if article.published_at else '日時不明' }}
                                </time>
                            </div>
                        </div>
                    </td>
                    <td class="cell-score">
                        {% if article.inference %}
                            {{ article.inference.risk_score }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td>
                        {% if article.inference %}
                            <p class="cell-text">{{ article.inference.summary }}</p>
                        {% else %}
                            <a href="{{ url_for('main.result_ai', article_id=article.id) }}" class="link-inline">AI推論を見る</a>
                        {% endif %}
                    </td>
                    <td>
                        <p class="cell-text">{{ article.body }}</p>
                        <div class="cell-sub"><a href="{{ article.url }}" target="_blank" rel="noreferrer noopener">元記事</a></div>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="4" class="empty">該当する記事がありません</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</section>

{% if pagination.pages > 1 %}
<nav class="pagination">
    {% set prev_page = pagination.page - 1 %}
    {% set next_page = pagination.page + 1 %}
    <a class="pagination__link{% if not pagination.has_prev %} is-disabled{% endif %}" href="{{ url_for('main.index', page=prev_page, q=filters.q or None, start=filters.start or None, end=filters.end or None) if pagination.has_prev else '#' }}">&larr; 前へ</a>
    <span class="pagination__info">{{ pagination.page }} / {{ pagination.pages }}</span>
    <a class="pagination__link{% if not pagination.has_next %} is-disabled{% endif %}" href="{{ url_for('main.index', page=next_page, q=filters.q or None, start=filters.start or None, end=filters.end or None) if pagination.has_next else '#' }}">次へ &rarr;</a>
</nav>
{% endif %}
{% endblock %}
