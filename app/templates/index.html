{% extends 'layout.html' %}

{% block title %}トップ - Virtual News Reader{% endblock %}

{% block content %}
<div class="sr-only" aria-hidden="true">
    {% for article in articles %}
    {{ article.title }}
    {% endfor %}
</div>
<section class="surface surface--primary">
    <div class="surface__header">
        <div>
            <h2>記事URLをスクレイピング</h2>
            <p class="surface__description">ニュース記事のURLを貼り付けるだけで、AIリスク評価まで一気に実行します。</p>
        </div>
        <span class="surface__hint">STEP 1</span>
    </div>
    <form class="scrape-form" method="post" action="{{ url_for('main.scrape') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <label for="url" class="sr-only">スクレイピングするURLを入力</label>
        <div class="scrape-form__field">
            <input id="url" name="url" type="url" placeholder="https://example.com/article/..." required>
            <p class="scrape-form__note">ニュース記事のURLに対応しています</p>
        </div>
        <button class="button button--primary" type="submit">実行する</button>
    </form>
</section>

<section class="surface surface--accent">
    <div class="surface__header">
        <div>
            <h2>リスク監視ダッシュボード</h2>
            <p class="surface__description">蓄積した記事からAIカバレッジやリスク傾向をリアルタイムで把握できます。</p>
        </div>
        <span class="surface__hint">INSIGHT</span>
    </div>
    <div class="insight-grid">
        <div class="insight-card">
            <span class="insight-card__label">登録済み記事</span>
            <strong class="insight-card__value">{{ metrics.total_articles }}</strong>
            <span class="insight-card__sub">AI解析率 {{ (metrics.ai_coverage_ratio * 100)|round(1) }}%</span>
        </div>
        <div class="insight-card">
            <span class="insight-card__label">平均リスクスコア</span>
            <strong class="insight-card__value">{{ metrics.average_risk_score }}</strong>
            <span class="insight-card__sub">高リスク検知 {{ metrics.high_risk_articles }} 件</span>
        </div>
        <div class="insight-card insight-card--highlight">
            <span class="insight-card__label">直近の高リスク</span>
            {% if metrics.highest_risk_title %}
            <strong class="insight-card__value">{{ metrics.highest_risk_score }}</strong>
            <span class="insight-card__sub">
                <a href="{{ url_for('main.result', article_id=metrics.highest_risk_article_id) }}">
                    {{ metrics.highest_risk_title }}
                </a>
            </span>
            {% else %}
            <strong class="insight-card__value">--</strong>
            <span class="insight-card__sub">AI推論がまだありません</span>
            {% endif %}
        </div>
        <div class="insight-card insight-card--distribution">
            <span class="insight-card__label">リスク分布</span>
            <ul class="insight-distribution">
                {% for band in risk_levels %}
                {% set count = metrics.risk_distribution.get(band.slug, 0) %}
                <li class="insight-distribution__item" aria-label="{{ band.badge }}">
                    <span class="insight-distribution__badge">{{ band.badge }}</span>
                    <span class="insight-distribution__count">{{ count }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</section>

<section class="surface surface--latest">
    <div class="surface__header">
        <div>
            <h2>最新ニュースから選ぶ</h2>
            <p class="surface__description">Virtual Newsの記事を取得。ワンクリックでスクレイプとAI評価を実行できます。</p>
        </div>
        <span class="surface__hint">STEP 2</span>
    </div>

    {% for provider in feed_providers %}
    {% set provider_articles = latest_articles_group.get(provider.slug, []) %}
    <div class="latest-feed__group">
        <div class="latest-feed__group-header">
            <h3>{{ provider.label }}</h3>
            <a class="chip chip--ghost" href="{{ url_for('main.latest_feed', source=provider.slug) }}">一覧を見る →</a>
        </div>

        {% if provider_articles %}
        <div class="latest-feed">
            {% for item in provider_articles %}
            <article class="latest-feed__item">
                <div class="latest-feed__meta">
                    <h4 class="latest-feed__title">{{ item.title }}</h4>
                    <div class="latest-feed__info">
                        <span class="latest-feed__source">{{ item.source }}</span>
                        {% if item.published_display %}
                        <time datetime="{{ item.published_iso }}">{{ item.published_display }}</time>
                        {% endif %}
                    </div>
                </div>
                <div class="latest-feed__actions">
                    <a class="chip chip--ghost" href="{{ item.url }}" target="_blank" rel="noopener noreferrer">元記事</a>
                    <form method="post" action="{{ url_for('main.scrape') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="url" value="{{ item.url }}">
                        <button class="button button--primary" type="submit">AI解析する</button>
                    </form>
                </div>
            </article>
            {% endfor %}
        </div>
        {% else %}
        <div class="latest-feed__empty">
            <p>{{ provider.label }} の記事を取得できませんでした。</p>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</section>
<a class="pagination__link{% if not pagination.has_prev %} is-disabled{% endif %}"
    href="{{ url_for('main.index', page=prev_page, q=filters.q or None, start=filters.start or None, end=filters.end or None, sort=filters.sort, order=filters.order, risk=filters.risk or None) if pagination.has_prev else '#' }}">&larr;
    前へ</a>
<span class="pagination__info">{{ pagination.page }} / {{ pagination.pages or 1 }}</span>
<a class="pagination__link{% if not pagination.has_next %} is-disabled{% endif %}"
    href="{{ url_for('main.index', page=next_page, q=filters.q or None, start=filters.start or None, end=filters.end or None, sort=filters.sort, order=filters.order, risk=filters.risk or None) if pagination.has_next else '#' }}">次へ
    &rarr;</a>
</nav>
</section>
{% endblock %}
