# プロジェクト改善計画

作成日: 2025-10-27

## プロジェクト概要

Yahoo!ニュース記事をスクレイピングし、AIがリスク判定と要約を行うFlaskベースのダッシュボードアプリ。
RSS取得、記事スクレイピング、AI推論、リスク分析まで一連のワークフローを自動化。

## 現状の実装状況

### ✅ 実装済み機能

#### コア機能
- **スクレイピング**: Yahoo!ニュースRSS（9カテゴリ・12メディア・660件以上）からの自動取得
- **AI機能**: OpenAI API (GPT-4o-mini) による要約とリスクスコア算出
- **ダッシュボード**: セッションベースログイン、可視化、検索・フィルタリング
- **REST API**: 記事CRUD、レート制限、Basic認証・Bearer認証対応
- **ML機能**: scikit-learn による分類モデル学習・評価スクリプト

#### 品質・運用
- **テスト**: pytest による主要機能のカバレッジ（11ファイル）
- **データベース**: SQLAlchemy + Alembic によるマイグレーション管理
- **CLI**: 記事取得、AI再実行、エクスポート等の管理コマンド

#### デプロイ準備
- AWS CodeBuild 設定 (`buildspec.yml`)
- EC2 デプロイスクリプト (`deploy.sh`)
- systemd サービス設定
- Nginx リバースプロキシ設定

### 📊 技術スタック

```
Backend:  Flask 3.0.3, SQLAlchemy, Alembic
AI:       OpenAI API (gpt-4o-mini), scikit-learn
Frontend: Jinja2, Vanilla CSS (Glassmorphism)
Infra:    Gunicorn, Nginx, systemd
Testing:  pytest, pytest-mock
ML:       pandas, numpy, scikit-learn, joblib
```

### 📈 コード統計

- 総行数: 約1,672行（app配下のみ）
- サービス層: 7ファイル
- テストファイル: 11ファイル
- ドキュメント: README.md, 設計資料

---

## 🔴 緊急修正が必要な項目

### 1. AI機能のバグ修正

**場所**: `app/services/ai.py` 63行目付近

**問題**:
```python
response = client.responses.create(  # ❌ 間違ったメソッド
```

**修正**:
```python
response = client.chat.completions.create(  # ✅ 正しいメソッド
```

**影響**: 現状AI機能が全く動作しない可能性が高い

**優先度**: 🔥 最高（即座に修正必要）

---

## 🚀 追加・改善すべき機能

### 優先度：高（すぐに対応すべき）

#### 1. デプロイ環境の整備

**1.1 Docker化**
- [ ] `Dockerfile` の作成（本番用）
- [ ] `docker-compose.yml` の作成（開発・本番両対応）
- [ ] マルチステージビルドによる軽量化
- [ ] ヘルスチェック設定

**理由**: 現状 `.devcontainer/Dockerfile` のみで本番デプロイ用がない

**1.2 CI/CD パイプライン**
- [ ] GitHub Actions ワークフロー作成
  - [ ] テスト自動実行
  - [ ] リント・フォーマットチェック
  - [ ] Docker イメージビルド＆プッシュ
  - [ ] 自動デプロイ（staging/production）
- [ ] ブランチ保護ルール設定

**理由**: 現状手動デプロイのみで自動化されていない

**1.3 環境変数・シークレット管理**
- [ ] AWS Systems Manager Parameter Store 連携
- [ ] AWS Secrets Manager 連携
- [ ] 環境ごとの設定ファイル分離（dev/staging/prod）
- [ ] `.env.example` の充実化

**1.4 ヘルスチェック・モニタリング**
- [ ] `/health` エンドポイント追加
- [ ] `/metrics` エンドポイント（Prometheus形式）
- [ ] データベース接続チェック
- [ ] OpenAI API接続チェック

#### 2. AI機能の強化

**2.1 複数AIプロバイダー対応**
- [ ] Anthropic Claude 対応
- [ ] Google Gemini 対応
- [ ] プロバイダー切り替え機能（フォールバック付き）
- [ ] レスポンス時間・コスト比較

**2.2 AI コスト管理**
- [ ] トークン数カウント・ロギング
- [ ] 月次コスト上限設定
- [ ] モデル別使用統計
- [ ] コスト最適化アラート

**2.3 バッチ処理機能**
- [ ] 複数記事の並列AI処理
- [ ] OpenAI Batch API 対応
- [ ] リトライ・エラーハンドリング強化
- [ ] 処理状況の可視化

#### 3. セキュリティ強化

**3.1 認証・認可**
- [ ] JWT トークン認証の実装
- [ ] トークンリフレッシュ機能
- [ ] API Key ローテーション機能
- [ ] RBAC（ロールベースアクセス制御）の基礎実装

**3.2 保護機能**
- [ ] CSRF トークン保護（Flask-WTF）
- [ ] レート制限の細分化（エンドポイント別）
- [ ] SQL インジェクション対策の再確認
- [ ] XSS 対策の再確認

**3.3 セキュリティヘッダー**
- [ ] Content-Security-Policy
- [ ] X-Frame-Options
- [ ] X-Content-Type-Options
- [ ] Strict-Transport-Security

---

### 優先度：中（余裕があれば対応）

#### 4. 運用・監視

**4.1 ロギング強化**
- [ ] 構造化ロギング（JSON形式）
- [ ] ログレベル別の出力先分離
- [ ] アクセスログの詳細化
- [ ] エラートレーシング（Sentry等）

**4.2 アラート・通知**
- [ ] Slack 通知機能
- [ ] メール通知機能
- [ ] 高リスク記事の自動アラート
- [ ] システムエラー通知

**4.3 パフォーマンス最適化**
- [ ] Redis キャッシュ導入
- [ ] データベースインデックス最適化
- [ ] N+1クエリ問題の解消
- [ ] API レスポンス時間の測定・改善

**4.4 バックアップ・リストア**
- [ ] データベース自動バックアップ
- [ ] S3 へのバックアップ保存
- [ ] リストア手順のドキュメント化
- [ ] 定期的なリストアテスト

#### 5. 機能拡張

**5.1 ユーザー管理**
- [ ] マルチユーザー対応
- [ ] ユーザー登録・削除機能
- [ ] 権限レベル設定（管理者・閲覧者等）
- [ ] ユーザーごとのダッシュボード

**5.2 リアルタイム機能**
- [ ] WebSocket によるリアルタイム更新
- [ ] Server-Sent Events による通知
- [ ] スクレイピング進捗のリアルタイム表示
- [ ] 新着記事の自動表示

**5.3 自動化・スケジューリング**
- [ ] Celery + Redis のセットアップ
- [ ] Celery Beat による定期実行
- [ ] 定期的なRSSフィード取得
- [ ] 自動AI分析スケジュール

**5.4 データエクスポート拡張**
- [ ] JSON エクスポート
- [ ] Excel エクスポート
- [ ] PDF レポート生成
- [ ] API経由のエクスポート

---

### 優先度：低（将来的に検討）

#### 6. 高度な分析機能

- [ ] トレンド分析（時系列）
- [ ] キーワード抽出・タグ付け
- [ ] 記事間の類似度分析
- [ ] センチメント分析
- [ ] エンティティ認識（人名・組織名等）

#### 7. UI/UX改善

- [ ] ダークモード対応
- [ ] レスポンシブデザインの強化
- [ ] アクセシビリティ対応（ARIA等）
- [ ] PWA 対応（オフライン機能）
- [ ] 多言語対応（i18n）

#### 8. 外部連携

- [ ] Slack Bot 統合
- [ ] Microsoft Teams 統合
- [ ] Webhook による外部通知
- [ ] BI ツール連携（Tableau、Power BI等）
- [ ] Zapier/IFTTT 連携

---

## 📋 実装ロードマップ

### フェーズ 1: 緊急修正・デプロイ準備（1-2週間）✅ 完了

1. ✅ AI機能バグ修正 - `de7cc66`
2. ✅ Dockerfile & docker-compose.yml 作成 - `710b53e`
3. ✅ GitHub Actions CI/CD 構築 - `d69f747`
4. ✅ ヘルスチェックエンドポイント追加 - `de7cc66`
5. ✅ .gitignore拡張（環境変数管理の改善）- `cf94629`
6. ✅ テスト修正・追加 - `58e75c3`

### フェーズ 2: セキュリティ・監視強化（2-3週間）

1. JWT認証実装
2. CSRF保護追加
3. セキュリティヘッダー設定
4. ロギング・モニタリング強化
5. エラー通知機能（Slack）

### フェーズ 3: AI機能拡張（2-3週間）

1. 複数AIプロバイダー対応
2. コスト管理機能
3. バッチ処理実装
4. AI推論履歴の可視化

### フェーズ 4: 運用最適化（2週間）

1. Redis キャッシュ導入
2. パフォーマンス最適化
3. バックアップ・リストア機能
4. ドキュメント整備

### フェーズ 5: 機能拡張（継続的）

1. マルチユーザー対応
2. リアルタイム機能
3. Celery スケジューリング
4. 高度な分析機能

---

## 🔧 必要な追加パッケージ

```txt
# デプロイ・運用
gunicorn==21.2.0
redis==5.0.1
celery==5.3.4

# セキュリティ
Flask-WTF==1.2.1
PyJWT==2.8.0
cryptography==41.0.7

# モニタリング
sentry-sdk==1.39.1
prometheus-client==0.19.0

# 通知
slack-sdk==3.26.1

# AI拡張
anthropic==0.8.1
google-generativeai==0.3.2

# キャッシュ
Flask-Caching==2.1.0
```

---

## 📝 次のアクションアイテム

### 今すぐ実行

1. **AI機能バグ修正** (`app/services/ai.py`)
2. **テスト実行**で動作確認
3. **Dockerfile作成**（本番用）
4. **docker-compose.yml作成**

### 今週中に実行

1. **GitHub Actions ワークフロー**作成
2. **ヘルスチェックエンドポイント**追加
3. **環境変数管理**の見直し
4. **デプロイ手順書**作成

### 今月中に実行

1. **JWT認証**実装
2. **セキュリティヘッダー**設定
3. **ロギング強化**
4. **Slack通知**機能

---

## 📚 参考資料

- [Flask公式ドキュメント](https://flask.palletsprojects.com/)
- [OpenAI API リファレンス](https://platform.openai.com/docs/api-reference)
- [Docker ベストプラクティス](https://docs.docker.com/develop/dev-best-practices/)
- [GitHub Actions ドキュメント](https://docs.github.com/ja/actions)
- [OWASP セキュリティガイド](https://owasp.org/)

---

## 💡 まとめ

このプロジェクトは非常によく設計されており、基本機能は充実しています。
次のステップとして、**AI機能の修正**と**デプロイ環境の整備**を優先的に進めることで、
本番運用可能な状態に持っていくことができます。

セキュリティとモニタリングを強化することで、エンタープライズレベルの品質を実現できるポテンシャルがあります。
